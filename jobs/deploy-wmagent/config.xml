<?xml version='1.0' encoding='UTF-8'?>
<project>
  <actions/>
  <description>Run full deployment of a WMAgent instance</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.plugins.trac.TracProjectProperty>
      <tracWebsite>https://svnweb.cern.ch/trac/CMSDMWM/</tracWebsite>
    </hudson.plugins.trac.TracProjectProperty>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>WMAGENT_VERSION</name>
          <description>Override wmagent version in deploy script: format &quot;@0.8.1pre1&quot; etc.
Blank for current deploy version.</description>
          <defaultValue>@0.8.10</defaultValue>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <scm class="hudson.scm.SubversionSCM">
    <locations>
      <hudson.scm.SubversionSCM_-ModuleLocation>
        <remote>svn+ssh://swakef@svn.cern.ch/reps/CMSDMWM/Infrastructure/trunk/Deployment</remote>
        <local>cfg</local>
      </hudson.scm.SubversionSCM_-ModuleLocation>
    </locations>
    <excludedRegions></excludedRegions>
    <includedRegions></includedRegions>
    <excludedUsers></excludedUsers>
    <excludedRevprop></excludedRevprop>
    <excludedCommitMessages></excludedCommitMessages>
    <workspaceUpdater class="hudson.scm.subversion.UpdateUpdater"/>
  </scm>
  <assignedNode>agent-slaves</assignedNode>
  <canRoam>false</canRoam>
  <disabled>true</disabled>
  <blockBuildWhenDownstreamBuilding>true</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers class="vector"/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>#!/bin/sh

if [ -e $PWD/current ]; then
  echo &quot;Stopping agent&quot;
  $PWD/current/config/wmagent/manage stop-agent
  echo &quot;Stopping services&quot;
  $PWD/current/config/wmagent/manage stop-services
  # remove old crons
  crontab -r || true
fi

rm -rf install current</command>
    </hudson.tasks.Shell>
    <hudson.tasks.Shell>
      <command>#!/bin/sh

rm -rf install
$PWD/cfg/Deploy -r comp=comp -t install -A slc5_amd64_gcc461 -s &apos;prep sw post&apos; $PWD wmagent${WMAGENT_VERSION}</command>
    </hudson.tasks.Shell>
    <hudson.tasks.Shell>
      <command>echo &quot;Starting agent services...&quot;

# force mysql to a reasonable size
perl -p -i -e &apos;s/set-variable = innodb_buffer_pool_size=2G/set-variable = innodb_buffer_pool_size=100M/&apos; current/config/mysql/my.cnf
perl -p -i -e &apos;s/set-variable = innodb_log_file_size=512M/set-variable = innodb_log_file_size=20M/&apos; current/config/mysql/my.cnf

$PWD/current/config/wmagent/manage activate-agent

echo &quot;Starting agent processes...&quot;
# divorce mysql and couchdb processes so they dont get killed
# https://wiki.jenkins-ci.org/display/JENKINS/ProcessTreeKiller
BUILD_ID=dontKillMe $PWD/current/config/wmagent/manage start-services</command>
    </hudson.tasks.Shell>
    <hudson.tasks.Shell>
      <command># edit config - change default team
#perl -p -i -e &apos;s/agentTeams =.*/agentTeams = &quot;TestTeam&quot;/&apos; current/config/wmagent/config-template.py
# Big hack - someone in the unit test wipes wmagent_ couchdb db&apos;s - rename to something else
#perl -p -i -e &apos;s/wmagent_/testagent_/&apos; current/config/wmagent/config-template.py
# change to test workqueue
#perl -p -i -e &apos;s!https://cmsweb.cern.ch/couchdb/workqueue!https://dev-cms-wq.cern.ch:8443/couchdb/workqueue!&apos; current/config/wmagent/config-template.py
# Use the mock submitter plugin - https://svnweb.cern.ch/trac/CMSDMWM/wiki/HOWTOMockGrid
#perl -p -i -e &apos;s/CondorPlugin/MockPlugin/&apos; current/config/wmagent/config-template.py
#echo &quot;
#config.BossAir.section_(&apos;MockPlugin&apos;)
#config.BossAir.MockPlugin.jobRunTime = 2
#config.BossAir.MockPlugin.mockPluginProcesses = 4
#config.BossAir.MockPlugin.fakeReport = &apos;FakeReport.pkl&apos;
#config.BossAir.MockPlugin.lcFakeReport = &apos;LogCollectFakeReport.pkl&apos;
#&quot; &gt;&gt; current/config/wmagent/config-template.py

# FIXME: Remove when updated beyond 0.8.8
#perl -p -i -e &apos;s!domain=self.getDomainName\(\)!domain=&quot;&quot;!&apos; current/apps/wmcore/lib/python2.6/site-packages/WMCore/Services/Requests.py

$PWD/current/config/wmagent/manage init-agent

export X509_USER_CERT=/etc/grid-security/hostcert.pem
export X509_USER_KEY=/etc/grid-security/hostkey.pem

# divorce mysql and couchdb processes so they dont get killed
# https://wiki.jenkins-ci.org/display/JENKINS/ProcessTreeKiller
#BUILD_ID=dontKillMe $PWD/current/config/wmagent/manage start-agent</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <hudson.plugins.chucknorris.CordellWalkerRecorder>
      <factGenerator/>
    </hudson.plugins.chucknorris.CordellWalkerRecorder>
    <hudson.tasks.BuildTrigger>
      <childProjects>WMCore-py2.6-mysql</childProjects>
      <threshold>
        <name>UNSTABLE</name>
        <ordinal>1</ordinal>
        <color>YELLOW</color>
      </threshold>
    </hudson.tasks.BuildTrigger>
  </publishers>
  <buildWrappers/>
</project>